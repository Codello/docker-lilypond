name: Automatic Update
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  update-fonts:
    name: Update Fonts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with: {submodules: recursive}
      - name: Update Submodules
        run: git submodule update --remote --recursive
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
            token: ${{ secrets.GITHUB_TOKEN }}
            branch: update-fonts
            commit-message: Update notation fonts
            title: Update Notation Fonts
            delete-branch: true
  update-lilypond:
    name: Update LilyPond
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Fetch Latest Versions
        # "download" source corresponds to the latest stable version.
        # "development" source corresponds to the latest dev version.
        run: |
          set -e
          for source in download development; do
            version=$(curl -sS "https://lilypond.org/$source.html" | grep -E --only-matching '\d+\.\d+\.\d+' | head -n1)
            VERSION=version jq '.[env.VERSION | capture("(?<v>\\d+.\\d+).\\d+").v].version = env.VERSION' versions.json > versions.json.tmp
            mv versions.json.tmp versions.json
          done
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
            token: ${{ secrets.GITHUB_TOKEN }}
            branch: update-lilypond
            commit-message: Update LilyPond
            title: Update LilyPond
            delete-branch: true

